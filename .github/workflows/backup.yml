name: Daily API Backup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'  # Todos los dÃ­as a la 1:00 AM (UTC)

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Obtener datos de la API con curl
        run: curl -X GET https://movimientos-del-alma-backend-develop.up.railway.app/users/getAllStudents -o users.json

      - name: Convertir JSON a SQL
        run: |
          jq -r '.response[] | "INSERT INTO students (id, identification_number, name, lastname, email, nationality) VALUES (''\(.id)'', ''\(.identification_number)'', ''\(.name)'', ''\(.lastname)'', ''\(.email)'', ''\(.nationality)'');"' users.json > backup_users_$(date +%Y%m%d%H%M%S).sql

      - name: Crear carpeta para el backup
        run: |
          mkdir -p backup
          mv backup/* backup/

      - name: Subir el backup como artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-database-backup
          path: backup/
